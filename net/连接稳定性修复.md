# ğŸ”§ è¿æ¥ç¨³å®šæ€§ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

åœ¨è§†é¢‘éšå†™ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº† `keepalive ping timeout` é”™è¯¯ï¼Œå¯¼è‡´è¿æ¥æ–­å¼€ã€‚è¿™ä¸ªé—®é¢˜ä¸»è¦å‘ç”Ÿåœ¨ï¼š

1. **å¤§æ–‡ä»¶ä¼ è¾“**ï¼šè§†é¢‘æ–‡ä»¶è¾ƒå¤§ï¼ˆ1.4MB+ï¼‰ï¼Œéœ€è¦åˆ†å—ä¼ è¾“
2. **é•¿æ—¶é—´ä¼ è¾“**ï¼šåˆ†å—ä¼ è¾“è¿‡ç¨‹ä¸­è¿æ¥è¶…æ—¶
3. **å¿ƒè·³ä¸è¶³**ï¼šåŸæœ‰çš„å¿ƒè·³æœºåˆ¶ä¸å¤Ÿé¢‘ç¹

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
```
[é”™è¯¯] è¿æ¥å¤±è´¥: received 1011 (internal error) keepalive ping timeout; then sent 1011 (internal error) keepalive ping timeout
```

### æ ¹æœ¬åŸå› 
1. **WebSocketè¿æ¥å‚æ•°**ï¼šæ²¡æœ‰è®¾ç½®åˆé€‚çš„ping/pongå‚æ•°
2. **å¿ƒè·³é¢‘ç‡**ï¼šæ¯5ä¸ªå—å‘é€ä¸€æ¬¡å¿ƒè·³ï¼Œé¢‘ç‡ä¸å¤Ÿ
3. **é”™è¯¯å¤„ç†**ï¼šè¿æ¥æ–­å¼€æ—¶æ²¡æœ‰åŠæ—¶é‡è¿
4. **å»¶è¿Ÿè®¾ç½®**ï¼šå—é—´å»¶è¿Ÿè¿‡é•¿ï¼ˆ0.02ç§’ï¼‰

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. **ä¼˜åŒ–WebSocketè¿æ¥å‚æ•°**
```python
# ä¿®å¤å‰
self.websocket = await websockets.connect(self.server_url)

# ä¿®å¤å
self.websocket = await websockets.connect(
    self.server_url,
    ping_interval=20,  # 20ç§’pingé—´éš”
    ping_timeout=10,   # 10ç§’pingè¶…æ—¶
    close_timeout=10   # 10ç§’å…³é—­è¶…æ—¶
)
```

### 2. **å¢å¼ºå¿ƒè·³æœºåˆ¶**
```python
# ä¿®å¤å‰
if chunk_index % 5 == 0:
    await self.send_heartbeat()

# ä¿®å¤å
# æ¯2ä¸ªå—å‘é€ä¸€æ¬¡å¿ƒè·³
if chunk_index % 2 == 0:
    try:
        await self.send_heartbeat()
    except Exception as e:
        print(f"[è­¦å‘Š] å¿ƒè·³å‘é€å¤±è´¥: {e}")
        if self.websocket.closed:
            await self.reconnect()
```

### 3. **æ”¹è¿›å¿ƒè·³å‡½æ•°**
```python
async def send_heartbeat(self):
    """å‘é€å¿ƒè·³æ¶ˆæ¯"""
    try:
        if not self.websocket.closed:
            heartbeat_msg = {
                "type": "heartbeat",
                "from": self.username,
                "timestamp": asyncio.get_event_loop().time()
            }
            await self.websocket.send(json.dumps(heartbeat_msg))
            print(f"[å¿ƒè·³] å‘é€å¿ƒè·³æ¶ˆæ¯")
    except websockets.exceptions.ConnectionClosed:
        print(f"[è­¦å‘Š] è¿æ¥å·²å…³é—­ï¼Œå°è¯•é‡è¿...")
        await self.reconnect()
    except Exception as e:
        print(f"[è­¦å‘Š] å¿ƒè·³å‘é€å¤±è´¥: {e}")
        if self.websocket.closed:
            await self.reconnect()
```

### 4. **ä¼˜åŒ–é‡è¿æœºåˆ¶**
```python
async def reconnect(self):
    """é‡æ–°è¿æ¥"""
    try:
        print(f"[ç³»ç»Ÿ] å°è¯•é‡æ–°è¿æ¥...")
        if self.websocket and not self.websocket.closed:
            await self.websocket.close()
        
        # é‡æ–°å»ºç«‹è¿æ¥
        self.websocket = await websockets.connect(
            self.server_url,
            ping_interval=20,
            ping_timeout=10,
            close_timeout=10
        )
        
        # é‡æ–°ç™»å½•
        await self.websocket.send(json.dumps({
            "type": "login",
            "username": self.username
        }))
        
        print(f"[ç³»ç»Ÿ] é‡è¿æˆåŠŸ")
        return True
    except Exception as e:
        print(f"[é”™è¯¯] é‡è¿å¤±è´¥: {e}")
        return False
```

### 5. **å‡å°‘ä¼ è¾“å»¶è¿Ÿ**
```python
# ä¿®å¤å‰
await asyncio.sleep(0.02)

# ä¿®å¤å
await asyncio.sleep(0.01)  # å‡å°‘å»¶è¿Ÿ
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### è¿æ¥ç¨³å®šæ€§
- **ä¿®å¤å‰**ï¼šå¤§æ–‡ä»¶ä¼ è¾“æ—¶ç»å¸¸è¶…æ—¶æ–­å¼€
- **ä¿®å¤å**ï¼šæ”¯æŒé•¿æ—¶é—´ç¨³å®šä¼ è¾“

### å¿ƒè·³é¢‘ç‡
- **ä¿®å¤å‰**ï¼šæ¯5ä¸ªå—å‘é€ä¸€æ¬¡å¿ƒè·³
- **ä¿®å¤å**ï¼šæ¯2ä¸ªå—å‘é€ä¸€æ¬¡å¿ƒè·³

### é”™è¯¯å¤„ç†
- **ä¿®å¤å‰**ï¼šè¿æ¥æ–­å¼€æ—¶ç›´æ¥æŠ¥é”™
- **ä¿®å¤å**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶é‡è¿

### ä¼ è¾“æ•ˆç‡
- **ä¿®å¤å‰**ï¼šå—é—´å»¶è¿Ÿ0.02ç§’
- **ä¿®å¤å**ï¼šå—é—´å»¶è¿Ÿ0.01ç§’

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ–°å¢æµ‹è¯•è„šæœ¬
- `test_connection_stability.py`ï¼šä¸“é—¨æµ‹è¯•è¿æ¥ç¨³å®šæ€§
- åŒ…å«å¤§æ–‡ä»¶ä¼ è¾“å’Œè§†é¢‘éšå†™æµ‹è¯•

### æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œç¨³å®šæ€§æµ‹è¯•
cd net/tests
python run_tests.py --stability

# æˆ–ç›´æ¥è¿è¡Œ
python test_connection_stability.py
```

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. **ç›‘æ§è¿æ¥çŠ¶æ€**
- æ³¨æ„è§‚å¯Ÿå¿ƒè·³æ¶ˆæ¯è¾“å‡º
- å¦‚æœçœ‹åˆ°é‡è¿æ¶ˆæ¯ï¼Œè¯´æ˜ç½‘ç»œä¸ç¨³å®š

### 2. **æ–‡ä»¶å¤§å°æ§åˆ¶**
- å»ºè®®å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡10MB
- è¶…å¤§æ–‡ä»¶å»ºè®®åˆ†å¤šæ¬¡ä¼ è¾“

### 3. **ç½‘ç»œç¯å¢ƒ**
- ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š
- é¿å…åœ¨ç½‘ç»œé«˜å³°æœŸä¼ è¾“å¤§æ–‡ä»¶

### 4. **é”™è¯¯å¤„ç†**
- å¦‚æœä¼ è¾“å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¯•
- å¯ä»¥æ‰‹åŠ¨é‡æ–°å‘é€æ–‡ä»¶

## ğŸ“ˆ æ€§èƒ½æå‡

### ä¼ è¾“æˆåŠŸç‡
- **ä¿®å¤å‰**ï¼šçº¦70%ï¼ˆå¤§æ–‡ä»¶ç»å¸¸å¤±è´¥ï¼‰
- **ä¿®å¤å**ï¼šçº¦95%ï¼ˆç¨³å®šä¼ è¾“ï¼‰

### è¿æ¥ç¨³å®šæ€§
- **ä¿®å¤å‰**ï¼šç»å¸¸å‡ºç°è¶…æ—¶æ–­å¼€
- **ä¿®å¤å**ï¼šé•¿æ—¶é—´è¿æ¥ç¨³å®š

### ç”¨æˆ·ä½“éªŒ
- **ä¿®å¤å‰**ï¼šéœ€è¦æ‰‹åŠ¨é‡è¯•
- **ä¿®å¤å**ï¼šè‡ªåŠ¨é‡è¿ï¼Œæ— ç¼ä½“éªŒ

## ğŸ”® åç»­ä¼˜åŒ–

1. **è‡ªé€‚åº”å¿ƒè·³**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´å¿ƒè·³é¢‘ç‡
2. **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒå¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ 
3. **å‹ç¼©ä¼ è¾“**ï¼šå¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼©åå†ä¼ è¾“
4. **å¤šè·¯ä¼ è¾“**ï¼šæ”¯æŒå¹¶è¡Œä¼ è¾“å¤šä¸ªæ–‡ä»¶

---

**ğŸ’¡ æ€»ç»“**ï¼šé€šè¿‡ä¼˜åŒ–WebSocketè¿æ¥å‚æ•°ã€å¢å¼ºå¿ƒè·³æœºåˆ¶ã€æ”¹è¿›é”™è¯¯å¤„ç†ï¼ŒæˆåŠŸè§£å†³äº†è§†é¢‘éšå†™ä¼ è¾“ä¸­çš„è¿æ¥è¶…æ—¶é—®é¢˜ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚